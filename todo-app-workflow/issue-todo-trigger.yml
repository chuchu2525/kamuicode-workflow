name: Issue TODO Trigger

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  actions: write

jobs:
  trigger-todo-creation:
    if: |
      (github.event.action == 'opened' && contains(github.event.issue.body, '@create-todo-app')) ||
      (github.event.action == 'created' && contains(github.event.comment.body, '@create-todo-app'))
    runs-on: ubuntu-latest
    steps:
      - name: Parse TODO app request
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const content = context.payload.action === 'opened' 
              ? context.payload.issue.body 
              : context.payload.comment.body;

            console.log('Action:', context.payload.action);
            console.log('Content:', content);

            // Check if content includes @create-todo-app
            if (!content.includes('@create-todo-app')) {
              core.setFailed('No @create-todo-app command found');
              return;
            }

            // Extract requirements from content
            const requirementsMatch = content.match(/è¦ä»¶\s*[ï¼š:]\s*(.+?)(?=\næŠ€è¡“|$)/s);
            const techMatch = content.match(/æŠ€è¡“\s*[ï¼š:]\s*(.+?)$/s);

            if (!requirementsMatch) {
              const user = context.eventName === 'issues' 
                ? context.payload.issue.user.login 
                : context.payload.comment.user.login;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `@${user} ã•ã‚“ã€ä»¥ä¸‹ã®å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ï¼š\n\n\`\`\`\n@create-todo-app\nè¦ä»¶ï¼š[ã‚¢ãƒ—ãƒªã®è¦ä»¶ã‚’è¨˜è¿°]\næŠ€è¡“ï¼š[basic-html/react-app/fullstack-app]\n\`\`\`\n\nâ€»è¦ä»¶ã¯è¤‡æ•°è¡Œã§è¨˜è¿°å¯èƒ½ã§ã™ã€‚`
              });
              core.setFailed('Invalid format');
              return;
            }

            // Clean up the extracted text
            const requirements = requirementsMatch[1].trim().replace(/\s+/g, ' ');

            // Determine app type from tech specification or default to basic-html
            let appType = 'basic-html';
            if (techMatch) {
              const techText = techMatch[1].toLowerCase();
              if (techText.includes('react') || techText.includes('typescript')) {
                appType = 'react-app';
              } else if (techText.includes('fullstack') || techText.includes('node') || techText.includes('mongodb')) {
                appType = 'fullstack-app';
              }
            }

            core.setOutput('requirements', requirements);
            core.setOutput('app_type', appType);

            // Add reaction to acknowledge
            if (context.eventName === 'issue_comment') {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            } else {
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                content: 'rocket'
              });
            }

            // Post status comment
            const appTypeDescription = {
              'basic-html': 'ğŸŒŸ Basic HTML App (HTML + CSS + JavaScript)',
              'react-app': 'âš¡ React App (React + TypeScript)',
              'fullstack-app': 'ğŸš€ Full Stack App (React + Node.js + MongoDB)'
            };

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– AI TODO ã‚¢ãƒ—ãƒªç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸï¼\n\n**è¦ä»¶**: ${requirements}\n**ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—**: ${appTypeDescription[appType]}\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é€²è¡ŒçŠ¶æ³ã¯[ã“ã¡ã‚‰](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã§ç¢ºèªã§ãã¾ã™ã€‚\n\nğŸ”„ **å‡¦ç†ãƒ•ãƒ­ãƒ¼**:\n1. ğŸ“‹ è¦ä»¶åˆ†æ - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã‚’åˆ†æã—ã¦æŠ€è¡“ä»•æ§˜ã‚’ä½œæˆ\n2. ğŸ’» ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ - æŒ‡å®šã•ã‚ŒãŸæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã§ã‚¢ãƒ—ãƒªç”Ÿæˆ\n3. ğŸ” å“è³ªæ¤œè¨¼ - æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ãƒ»å‹•ä½œç¢ºèªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼\n4. ğŸ“ PRä½œæˆ - ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æå‡º\n\nâ° ã‚¢ãƒ—ãƒªç”Ÿæˆã«ã¯10-15åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚`
            });

      - name: Trigger TODO app creation workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const requirements = '${{ steps.parse.outputs.requirements }}';
            const appType = '${{ steps.parse.outputs.app_type }}';

            console.log('Triggering workflow with:', { requirements, appType });

            // Trigger the TODO app creation workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'create-todo-app.yml',
              ref: 'main',
              inputs: {
                app_requirements: requirements,
                app_type: appType
              }
            });

      - name: Update issue on completion
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const requirements = '${{ steps.parse.outputs.requirements }}';
            const appType = '${{ steps.parse.outputs.app_type }}';

            const appTypeDescription = {
              'basic-html': 'ğŸŒŸ **Basic HTML App** - ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡ãªTODOã‚¢ãƒ—ãƒª',
              'react-app': 'âš¡ **React App** - ãƒ¢ãƒ€ãƒ³ãªTypeScript TODOã‚¢ãƒ—ãƒª',
              'fullstack-app': 'ğŸš€ **Full Stack App** - æœ¬æ ¼çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³'
            };

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… AI TODO ã‚¢ãƒ—ãƒªç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã—ãŸï¼\n\n${appTypeDescription[appType]}\n\nğŸ¯ **å‡¦ç†å†…å®¹**:\n1. ğŸ“‹ **è¦ä»¶åˆ†æ** - ã‚·ã‚¹ãƒ†ãƒ åˆ†æã®å°‚é–€å®¶ãŒè¦ä»¶ã‚’è©³ç´°ã«åˆ†æ\n2. ğŸ’» **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ** - ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™ºè€…ãŒé«˜å“è³ªãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n3. ğŸ” **å“è³ªæ¤œè¨¼** - æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ãƒ»å‹•ä½œç¢ºèª\n4. ğŸ“ **PRä½œæˆ** - å…¨æˆæœç‰©ã‚’ã¾ã¨ã‚ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ\n\nğŸ“Š **ç”Ÿæˆäºˆå®š**:\n- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«\n- æŠ€è¡“ä»•æ§˜æ›¸ãƒ»è¦ä»¶æ›¸\n- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †æ›¸\n- å“è³ªæ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ\n\né€²è¡ŒçŠ¶æ³ã¯[Actions](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions)ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nå®Œäº†å¾Œã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ï¼`
            });

      - name: Handle error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n**ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**:\n- è¦ä»¶ãŒæ­£ã—ãè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n- API ã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n- å†åº¦ã‚³ãƒ¡ãƒ³ãƒˆã§ \`@create-todo-app\` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„\n\n**æ­£ã—ã„å½¢å¼**:\n\`\`\`\n@create-todo-app\nè¦ä»¶ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¹ã‚¯ç®¡ç†ã€è¿½åŠ ãƒ»å‰Šé™¤ãƒ»å®Œäº†æ©Ÿèƒ½\næŠ€è¡“ï¼šHTML + CSS + JavaScript\n\`\`\``
            });
