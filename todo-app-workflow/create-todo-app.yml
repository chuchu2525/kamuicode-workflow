name: Create TODO App

on:
  workflow_dispatch:
    inputs:
      app_requirements:
        description: "TODOã‚¢ãƒ—ãƒªã®è¦ä»¶ï¼ˆæ©Ÿèƒ½ã€æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ç­‰ï¼‰"
        required: true
        type: string
      app_type:
        description: "ã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒ—"
        required: true
        type: choice
        options:
          - "basic-html"
          - "react-app"
          - "fullstack-app"
        default: "basic-html"

jobs:
  setup-project:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create branch for app generation
        id: create-branch
        run: |
          BRANCH_NAME="todo-app/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="todo-app-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  requirements-analysis:
    runs-on: ubuntu-latest
    needs: [setup-project]
    permissions:
      contents: write
    outputs:
      analysis-completed: ${{ steps.analysis.outputs.completed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-project.outputs.branch-name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code

      - name: è¦ä»¶åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ“‹ Requirements Analysis Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"

          FOLDER_NAME="${{ needs.setup-project.outputs.folder-name }}"
          DOCS_DIR="$FOLDER_NAME/docs"
          USER_REQUIREMENTS="${{ inputs.app_requirements }}"
          APP_TYPE="${{ inputs.app_type }}"

          echo "User requirements: $USER_REQUIREMENTS"
          echo "App type: $APP_TYPE"
          echo "Documentation folder: $DOCS_DIR"

          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$DOCS_DIR" ]; then
            mkdir -p "$DOCS_DIR"
            echo "ğŸ“ Created documentation folder: $DOCS_DIR"
          fi

          PROMPT="ã‚ãªãŸã¯ã‚·ã‚¹ãƒ†ãƒ åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦ä»¶**: $USER_REQUIREMENTS
          **ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—**: $APP_TYPE

          ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          1. **$DOCS_DIR/requirements.md** - æ©Ÿèƒ½è¦ä»¶ãƒ»éæ©Ÿèƒ½è¦ä»¶
             - æ©Ÿèƒ½è¦ä»¶ï¼ˆå…·ä½“çš„ãªæ©Ÿèƒ½ä¸€è¦§ï¼‰
             - éæ©Ÿèƒ½è¦ä»¶ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç­‰ï¼‰
             - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼
             - å—ã‘å…¥ã‚Œæ¡ä»¶

          2. **$DOCS_DIR/technical-spec.md** - æŠ€è¡“ä»•æ§˜æ›¸
             - æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯é¸å®šç†ç”±
             - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
             - ãƒ‡ãƒ¼ã‚¿æ§‹é€ è¨­è¨ˆ
             - APIè¨­è¨ˆï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

          3. **$DOCS_DIR/file-structure.md** - ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ è¨­è¨ˆ
             - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
             - å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²èª¬æ˜
             - å‘½åè¦å‰‡

          4. **$DOCS_DIR/implementation-plan.md** - å®Ÿè£…è¨ˆç”»
             - å®Ÿè£…é †åº
             - å„æ®µéšã®æˆæœç‰©
             - å“è³ªä¿è¨¼è¨ˆç”»
             - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

          **é‡è¦ãªåˆ¶ç´„**:
          - ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°: æœ€å¤§8å€‹
          - å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 500è¡Œä»¥å†…
          - æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: $APP_TYPE ã«é©ã—ãŸã‚‚ã®
          - å®Ÿè£…å¯èƒ½æ€§: å¿…ãšå‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã§ãã‚‹è¨­è¨ˆ
          - å…·ä½“æ€§: æŠ½è±¡çš„ã§ãªãå…·ä½“çš„ãªå†…å®¹

          **ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—åˆ¥ã®è€ƒæ…®äº‹é …**:
          - basic-html: ã‚·ãƒ³ãƒ—ãƒ«ã€è»½é‡ã€ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§é‡è¦–
          - react-app: ãƒ¢ãƒ€ãƒ³ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã€å‹å®‰å…¨æ€§
          - fullstack-app: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€APIè¨­è¨ˆ

          å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è©³ç´°ã§å®Ÿç”¨çš„ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚"

          echo "ğŸš€ Starting Requirements Analysis Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 15 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }

          # ç”Ÿæˆã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated documentation..."

          REQUIRED_DOCS=("requirements.md" "technical-spec.md" "file-structure.md" "implementation-plan.md")

          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$DOCS_DIR/$doc" ]; then
              echo "::notice::âœ… Document generated: $doc"
              echo "First 5 lines of $doc:"
              head -5 "$DOCS_DIR/$doc"
              echo ""
            else
              echo "::warning::âš ï¸ Document not found: $doc"
            fi
          done

          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Commit and push documentation
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-project.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No documentation files to commit"
          else
            git commit -m "Add requirements analysis: ${{ inputs.app_requirements }}"
            git push origin ${{ needs.setup-project.outputs.branch-name }}
          fi

  code-generation:
    runs-on: ubuntu-latest
    needs: [setup-project, requirements-analysis]
    permissions:
      contents: write
    outputs:
      generation-completed: ${{ steps.generate.outputs.completed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-project.outputs.branch-name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code

      - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ’» Code Generation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"

          FOLDER_NAME="${{ needs.setup-project.outputs.folder-name }}"
          APP_DIR="$FOLDER_NAME/app"
          DOCS_DIR="$FOLDER_NAME/docs"
          USER_REQUIREMENTS="${{ inputs.app_requirements }}"
          APP_TYPE="${{ inputs.app_type }}"

          echo "User requirements: $USER_REQUIREMENTS"
          echo "App type: $APP_TYPE"
          echo "Target folder: $APP_DIR"

          # ã‚¢ãƒ—ãƒªãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$APP_DIR" ]; then
            mkdir -p "$APP_DIR"
            echo "ğŸ“ Created app folder: $APP_DIR"
          fi

          # ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ
          case "$APP_TYPE" in
            "basic-html")
              TECH_PROMPT="HTML + CSS + JavaScriptï¼ˆãƒãƒ‹ãƒ©JSï¼‰ã§ã‚·ãƒ³ãƒ—ãƒ«ãªTODOã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆ"
              FILES_PROMPT="index.html, style.css, script.js, README.md"
              SPECIFIC_INSTRUCTIONS="
              - ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
              - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ
              - ãƒ¢ãƒ€ãƒ³ãªCSSï¼ˆFlexbox/Gridä½¿ç”¨ï¼‰
              - ES6+ã®JavaScriptä½¿ç”¨
              - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ"
              ;;
            "react-app")
              TECH_PROMPT="React + TypeScriptã§ãƒ¢ãƒ€ãƒ³ãªTODOã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆ"
              FILES_PROMPT="src/App.tsx, src/components/, src/hooks/, src/types/, package.json, README.md"
              SPECIFIC_INSTRUCTIONS="
              - TypeScriptä½¿ç”¨ã§å‹å®‰å…¨æ€§ç¢ºä¿
              - ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯æ´»ç”¨
              - Context APIä½¿ç”¨
              - Viteè¨­å®š
              - ESLint/Prettierè¨­å®š"
              ;;
            "fullstack-app")
              TECH_PROMPT="React + Node.js + Express + MongoDBã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯TODOã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆ"
              FILES_PROMPT="frontend/, backend/, package.json, docker-compose.yml, README.md"
              SPECIFIC_INSTRUCTIONS="
              - REST APIè¨­è¨ˆ
              - JWTèªè¨¼å®Ÿè£…
              - MongoDBæ¥ç¶š
              - CORSè¨­å®š
              - ç’°å¢ƒå¤‰æ•°ç®¡ç†"
              ;;
          esac

          PROMPT="ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™ºè€…ã§ã™ã€‚

          **è¦ä»¶**: $USER_REQUIREMENTS
          **æŠ€è¡“æŒ‡ç¤º**: $TECH_PROMPT
          **å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $APP_DIR/

          **ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«**: $FILES_PROMPT

          **æŠ€è¡“çš„è¦ä»¶**: $SPECIFIC_INSTRUCTIONS

          **é‡è¦ãªåˆ¶ç´„**:
          1. å¿…ãšå‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å«ã‚ã‚‹
          3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®
          4. ã‚³ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã‚’è¨˜è¼‰
          5. æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã€å„500è¡Œä»¥å†…

          **æ©Ÿèƒ½è¦ä»¶**:
          - ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤
          - å®Œäº†çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
          - ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
          - æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
          - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

          **å“è³ªè¦ä»¶**:
          - ã‚¯ãƒªãƒ¼ãƒ³ãªã‚³ãƒ¼ãƒ‰
          - é©åˆ‡ãªå‘½åè¦å‰‡
          - ä¿å®ˆæ€§ã®é«˜ã„æ§‹é€ 
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

          **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§**:
          ç”Ÿæˆå‰ã« $DOCS_DIR/ å†…ã®è¦ä»¶æ›¸ã‚’å‚ç…§ã—ã¦ã€è©³ç´°ãªä»•æ§˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          ç”Ÿæˆå¾Œã€å„ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"

          echo "ğŸš€ Starting Code Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 20 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }

          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸ’» Checking generated application files..."

          if [ -d "$APP_DIR" ]; then
            FILE_COUNT=$(find "$APP_DIR" -type f | wc -l)
            echo "::notice::ğŸ“ Generated $FILE_COUNT files"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "Generated files:"
              find "$APP_DIR" -type f | head -10
              
              # ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
              case "$APP_TYPE" in
                "basic-html")
                  MAIN_FILES=("index.html" "style.css" "script.js")
                  ;;
                "react-app")
                  MAIN_FILES=("package.json" "src/App.tsx")
                  ;;
                "fullstack-app")
                  MAIN_FILES=("package.json" "frontend" "backend")
                  ;;
              esac
              
              for file in "${MAIN_FILES[@]}"; do
                if [ -f "$APP_DIR/$file" ] || [ -d "$APP_DIR/$file" ]; then
                  echo "::notice::âœ… Main file/directory found: $file"
                else
                  echo "::warning::âš ï¸ Main file/directory missing: $file"
                fi
              done
            else
              echo "::error::âŒ No files were generated"
              exit 1
            fi
          else
            echo "::error::âŒ App directory not found"
            exit 1
          fi

          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Commit and push application
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-project.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No application files to commit"
          else
            git commit -m "Add generated TODO app: ${{ inputs.app_type }}"
            git push origin ${{ needs.setup-project.outputs.branch-name }}
          fi

  quality-assurance:
    runs-on: ubuntu-latest
    needs: [setup-project, code-generation]
    permissions:
      contents: write
    outputs:
      qa-completed: ${{ steps.qa.outputs.completed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-project.outputs.branch-name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: å“è³ªæ¤œè¨¼
        id: qa
        run: |
          echo "::group::ğŸ” Quality Assurance Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"

          FOLDER_NAME="${{ needs.setup-project.outputs.folder-name }}"
          APP_DIR="$FOLDER_NAME/app"
          APP_TYPE="${{ inputs.app_type }}"

          echo "ğŸ” ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."
          echo "App directory: $APP_DIR"
          echo "App type: $APP_TYPE"

          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèª
          if [ ! -d "$APP_DIR" ]; then
            echo "::error::âŒ ã‚¢ãƒ—ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $APP_DIR"
            exit 1
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          FILE_COUNT=$(find "$APP_DIR" -type f | wc -l)
          echo "::notice::ğŸ“ Total files: $FILE_COUNT"

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "::error::âŒ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—åˆ¥ã®æ¤œè¨¼
          case "$APP_TYPE" in
            "basic-html")
              echo "ğŸŒŸ Basic HTML app validation..."
              
              # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
              if [ -f "$APP_DIR/index.html" ]; then
                if grep -q "<html>" "$APP_DIR/index.html" && grep -q "</html>" "$APP_DIR/index.html"; then
                  echo "::notice::âœ… HTMLæ§‹é€ ç¢ºèª"
                else
                  echo "::error::âŒ HTMLæ§‹é€ ãŒä¸æ­£ã§ã™"
                  exit 1
                fi
                
                # åŸºæœ¬çš„ãªHTMLè¦ç´ ã®ç¢ºèª
                if grep -q "<title>" "$APP_DIR/index.html"; then
                  echo "::notice::âœ… HTMLã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª"
                fi
              else
                echo "::error::âŒ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                exit 1
              fi
              
              # CSSãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
              if [ -f "$APP_DIR/style.css" ]; then
                if [ -s "$APP_DIR/style.css" ]; then
                  echo "::notice::âœ… CSSãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª"
                else
                  echo "::warning::âš ï¸ CSSãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
                fi
              fi
              
              # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
              if [ -f "$APP_DIR/script.js" ]; then
                if node -c "$APP_DIR/script.js" 2>/dev/null; then
                  echo "::notice::âœ… JavaScriptæ§‹æ–‡ç¢ºèª"
                else
                  echo "::error::âŒ JavaScriptæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
                  node -c "$APP_DIR/script.js" || true
                  exit 1
                fi
              else
                echo "::error::âŒ script.jsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                exit 1
              fi
              ;;
              
            "react-app")
              echo "âš¡ React app validation..."
              
              # package.jsonã®æ¤œè¨¼
              if [ -f "$APP_DIR/package.json" ]; then
                if jq empty "$APP_DIR/package.json" 2>/dev/null; then
                  echo "::notice::âœ… package.jsonæ§‹æ–‡ç¢ºèª"
                  
                  # Reactä¾å­˜é–¢ä¿‚ã®ç¢ºèª
                  if jq -e '.dependencies.react' "$APP_DIR/package.json" >/dev/null; then
                    echo "::notice::âœ… Reactä¾å­˜é–¢ä¿‚ç¢ºèª"
                  else
                    echo "::warning::âš ï¸ Reactä¾å­˜é–¢ä¿‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                  fi
                else
                  echo "::error::âŒ package.jsonæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
                  exit 1
                fi
              else
                echo "::error::âŒ package.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                exit 1
              fi
              
              # TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
              if find "$APP_DIR" -name "*.tsx" -o -name "*.ts" | head -1 | read -r ts_file; then
                echo "::notice::âœ… TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: $(basename "$ts_file")"
              else
                echo "::warning::âš ï¸ TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
              ;;
              
            "fullstack-app")
              echo "ğŸš€ Full Stack app validation..."
              
              # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç¢ºèª
              if [ -d "$APP_DIR/frontend" ] || [ -f "$APP_DIR/package.json" ]; then
                echo "::notice::âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹é€ ç¢ºèª"
              else
                echo "::warning::âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
              
              # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç¢ºèª
              if [ -d "$APP_DIR/backend" ] || find "$APP_DIR" -name "server.js" -o -name "app.js" | head -1 | read -r; then
                echo "::notice::âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹é€ ç¢ºèª"
              else
                echo "::warning::âš ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
              
              # Dockerè¨­å®šç¢ºèª
              if [ -f "$APP_DIR/docker-compose.yml" ] || [ -f "$APP_DIR/Dockerfile" ]; then
                echo "::notice::âœ… Dockerè¨­å®šç¢ºèª"
              else
                echo "::warning::âš ï¸ Dockerè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
              ;;
          esac

          # README.mdã®ç¢ºèª
          if [ -f "$APP_DIR/README.md" ]; then
            if [ -s "$APP_DIR/README.md" ]; then
              echo "::notice::âœ… README.mdç¢ºèª"
              echo "README.md preview (first 5 lines):"
              head -5 "$APP_DIR/README.md"
            else
              echo "::warning::âš ï¸ README.mdãŒç©ºã§ã™"
            fi
          else
            echo "::warning::âš ï¸ README.mdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
          echo ""
          echo "ğŸ“Š File size analysis:"
          find "$APP_DIR" -type f -exec ls -lh {} \; | head -10

          # å¤§ãã™ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®è­¦å‘Š
          find "$APP_DIR" -type f -size +100k | while read -r large_file; do
            echo "::warning::âš ï¸ Large file detected: $large_file"
          done

          echo "::notice::âœ… å“è³ªæ¤œè¨¼å®Œäº†"
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

  create-pr:
    runs-on: ubuntu-latest
    needs:
      [setup-project, requirements-analysis, code-generation, quality-assurance]
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-project.outputs.branch-name }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::ğŸ“ Pull Request Creation"

          BRANCH_NAME="${{ needs.setup-project.outputs.branch-name }}"
          FOLDER_NAME="${{ needs.setup-project.outputs.folder-name }}"
          USER_REQUIREMENTS="${{ inputs.app_requirements }}"
          APP_TYPE="${{ inputs.app_type }}"

          echo "Branch: $BRANCH_NAME"
          echo "Folder: $FOLDER_NAME"
          echo "Requirements: $USER_REQUIREMENTS"
          echo "App type: $APP_TYPE"

          # æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FOLDER_NAME/" 2>/dev/null || true

          # æˆæœç‰©ã®ç¢ºèª
          APP_DIR="$FOLDER_NAME/app"
          DOCS_DIR="$FOLDER_NAME/docs"

          APP_FILES=0
          DOC_FILES=0

          if [ -d "$APP_DIR" ]; then
            APP_FILES=$(find "$APP_DIR" -type f | wc -l)
            echo "ğŸ“± App files: $APP_FILES"
          fi

          if [ -d "$DOCS_DIR" ]; then
            DOC_FILES=$(find "$DOCS_DIR" -type f | wc -l)
            echo "ğŸ“š Documentation files: $DOC_FILES"
          fi

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          COMMIT_MESSAGE="Add AI-generated TODO app: $APP_TYPE

          è¦ä»¶: $USER_REQUIREMENTS
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC

          ğŸ“Š Generation Summary:
          - App Type: $APP_TYPE
          - App Files: $APP_FILES
          - Documentation: $DOC_FILES files

          ğŸ¤– Generated with Claude Code SDK"

          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi

          git push origin $BRANCH_NAME

          # ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—åˆ¥ã®èª¬æ˜
          case "$APP_TYPE" in
            "basic-html")
              TYPE_DESCRIPTION="ğŸŒŸ **Basic HTML App** - ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡ãªTODOã‚¢ãƒ—ãƒª"
              USAGE_INSTRUCTIONS="1. \`$APP_DIR/index.html\` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
          2. ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤
          3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è‡ªå‹•ä¿å­˜"
              ;;
            "react-app")
              TYPE_DESCRIPTION="âš¡ **React App** - ãƒ¢ãƒ€ãƒ³ãªTypeScript TODOã‚¢ãƒ—ãƒª"
              USAGE_INSTRUCTIONS="1. \`cd $APP_DIR && npm install\`
          2. \`npm run dev\` ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:5173 ã‚’é–‹ã"
              ;;
            "fullstack-app")
              TYPE_DESCRIPTION="ğŸš€ **Full Stack App** - æœ¬æ ¼çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
              USAGE_INSTRUCTIONS="1. \`docker-compose up\` ã§ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
          2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000
          3. API: http://localhost:5000"
              ;;
          esac

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ¬æ–‡ä½œæˆ
          PR_BODY="ğŸ¤– AIç”ŸæˆTODOã‚¢ãƒ—ãƒª

          $TYPE_DESCRIPTION

          ## ğŸ“‹ ç”Ÿæˆæƒ…å ±
          - **è¦ä»¶**: $USER_REQUIREMENTS
          - **ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—**: $APP_TYPE
          - **ç”Ÿæˆæ—¥æ™‚**: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC

          ## ğŸ“Š ç”Ÿæˆçµæœ
          - ğŸ“± **ã‚¢ãƒ—ãƒªãƒ•ã‚¡ã‚¤ãƒ«**: $APP_FILES files
          - ğŸ“š **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: $DOC_FILES files

          ## ğŸ“ æ§‹é€ 
          \`\`\`
          $FOLDER_NAME/
          â”œâ”€â”€ app/           # ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
          â””â”€â”€ docs/          # æŠ€è¡“ä»•æ§˜æ›¸ãƒ»è¦ä»¶æ›¸
          \`\`\`

          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          $USAGE_INSTRUCTIONS

          ## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - ğŸ“‹ [è¦ä»¶æ›¸]($FOLDER_NAME/docs/requirements.md)
          - ğŸ”§ [æŠ€è¡“ä»•æ§˜æ›¸]($FOLDER_NAME/docs/technical-spec.md)
          - ğŸ“ [ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ]($FOLDER_NAME/docs/file-structure.md)
          - ğŸ“ [å®Ÿè£…è¨ˆç”»]($FOLDER_NAME/docs/implementation-plan.md)

          ## âœ… å“è³ªæ¤œè¨¼
          - âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†
          - âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèª
          - âœ… åŸºæœ¬æ©Ÿèƒ½æ¤œè¨¼

          ---
          ğŸ¤– Generated with [Claude Code SDK](https://github.com/anthropics/claude-code)"

          # GitHub Actions Summaryä½œæˆ
          echo "# ğŸ¤– AI TODO App Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Generation Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Requirements**: $USER_REQUIREMENTS" >> $GITHUB_STEP_SUMMARY
          echo "- **App Type**: $APP_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated**: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± **App Files**: $APP_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š **Documentation**: $DOC_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated pull request" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the application functionality" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge to main branch if satisfied" >> $GITHUB_STEP_SUMMARY

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
          gh pr create \
            --title "ğŸ¤– AI Generated TODO App: $APP_TYPE" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME

          echo "::notice::âœ… Pull request created successfully"
          echo "::endgroup::"
